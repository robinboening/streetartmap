Signart.controller "MapCtrl", [ "$scope", "$location", "leafletEvents", "Location", "markerLocation", ($scope, $location, leafletEvents, Location, markerLocation) ->
    angular.extend $scope,
      tiles:
        url: 'https://tiles.lyrk.org/ls/{z}/{x}/{y}?apikey={apikey}',
        options:
          apikey: '<%= Rails.configuration.lyrk_token %>'
          attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, Tiles by <a href="http://geodienste.lyrk.de/">Lyrk</a>'
      center:
        lat: 52.52000659999999,
        lng: 13.404954,
        zoom: 12
      defaults:
        scrollWheelZoom: false
      markers: []
      events:
        markers:
          enable: leafletEvents.getAvailableMarkerEvents()

    markerLocation.query().then (locations) ->
      $(locations).each (index, location) ->
        $scope.markers["#{location['id']}"] = {
          lat: location['latitude'],
          lng: location['longitude'],
          message: "<img src="+location['thumbnail']+"><p>#{location['fullAddress']}</p>"
        }

    # $scope.$on 'leafletDirectiveMarker.mouseover', (event, args) ->
    #   $scope.hovered_marker = args.markerName

    # $scope.$on 'leafletDirectiveMarker.mouseout', (event, args) ->
    #   $scope.hovered_marker = false

    $scope.$on 'leafletDirectiveMarker.popupopen', (event, args) ->
      Location.get(args.markerName).then (location) ->
        $scope.location = location
        $location.path "/locations/#{location.id}"

    $scope.$on 'leafletDirectiveMarker.popupclose', (event, args) ->
      $scope.popupActive = false
      $location.path "/"

]
